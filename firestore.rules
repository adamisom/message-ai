rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ===== HELPER FUNCTIONS =====
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isUser(uid) {
      return isAuthenticated() && request.auth.uid == uid;
    }
    
    // TEMPORARILY DISABLED - Testing if get() calls cause issues
    // function isPaidUser() {
    //   return isAuthenticated() && 
    //          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isPaidUser == true;
    // }
    
    // function isInTrial() {
    //   let user = get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    //   return user.trialEndsAt != null && user.trialEndsAt > request.time;
    // }
    
    // Simplified versions without get() calls - for testing
    function isPaidUser() {
      return isAuthenticated();
    }
    
    function isInTrial() {
      return false;
    }
    
    function isWorkspaceAdmin(workspaceId) {
      return isAuthenticated() &&
             get(/databases/$(database)/documents/workspaces/$(workspaceId)).data.adminUid == request.auth.uid;
    }
    
    function isWorkspaceMember(workspaceId) {
      return isAuthenticated() &&
             request.auth.uid in get(/databases/$(database)/documents/workspaces/$(workspaceId)).data.members;
    }
    
    // ===== PHASE 4: WORKSPACES =====
    
    // Workspaces collection - top-level
    match /workspaces/{workspaceId} {
      // Get individual workspace: members can read
      allow get: if isWorkspaceMember(workspaceId);
      
      // List workspaces: authenticated users can query (rules check each doc via 'list' below)
      // Security is enforced per-document: user must be admin OR member
      allow list: if isAuthenticated() && (
        resource.data.adminUid == request.auth.uid ||
        request.auth.uid in resource.data.members
      );
      
      // Only Pro users can create workspaces (trial users cannot)
      allow create: if isPaidUser() && 
                       isUser(request.resource.data.adminUid) &&
                       !get(/databases/$(database)/documents/users/$(request.auth.uid)).data.spamBanned;
      
      // Only admin can update workspace
      allow update: if isWorkspaceAdmin(workspaceId);
      
      // Only admin can delete workspace
      allow delete: if isWorkspaceAdmin(workspaceId);
    }
    
    // Workspace invitations
    match /workspace_invitations/{invitationId} {
      // Invitee and inviter can read
      allow read: if isAuthenticated() && 
                     (isUser(resource.data.invitedUserUid) || 
                      isUser(resource.data.invitedByUid));
      
      // Pro users (non-banned) can create invitations
      allow create: if isPaidUser() &&
                       !get(/databases/$(database)/documents/users/$(request.auth.uid)).data.spamBanned;
      
      // Invitee can update (accept/decline/spam)
      allow update: if isUser(resource.data.invitedUserUid);
      
      // Invitee or inviter can delete
      allow delete: if isUser(resource.data.invitedUserUid) || 
                       isUser(resource.data.invitedByUid);
    }
    
    // Group chat invitations (Sub-Phase 6.5)
    match /group_chat_invitations/{invitationId} {
      // Invitee and inviter can read
      allow read: if isAuthenticated() && 
                     (isUser(resource.data.invitedUserUid) || 
                      isUser(resource.data.invitedByUid));
      
      // Authenticated users (non-banned) can create invitations
      allow create: if isAuthenticated() &&
                       !get(/databases/$(database)/documents/users/$(request.auth.uid)).data.spamBanned;
      
      // Invitee can update (accept/decline/spam)
      allow update: if isUser(resource.data.invitedUserUid);
      
      // Invitee or inviter can delete
      allow delete: if isUser(resource.data.invitedUserUid) || 
                       isUser(resource.data.invitedByUid);
    }
    
    // ===== USERS COLLECTION =====
    
    // WIDE OPEN FOR DEBUGGING - TODO: Restrict properly
    match /users/{userId} {
      allow read, write: if true;
    }
    
    // ===== CONVERSATIONS =====
    
    // Conversations - only participants can read/write
    match /conversations/{conversationId} {
      // For reading existing conversations
      allow read: if request.auth != null && 
        request.auth.uid in resource.data.participants;
      
      // For creating new conversations - just need to be authenticated
      allow create: if request.auth != null;
      
      // For updating/deleting - must be a participant
      allow update, delete: if request.auth != null && 
        request.auth.uid in resource.data.participants;
    }
    
    // ===== MESSAGES =====
    
    // Messages - only conversation participants can read/write
    // Blocked users cannot send direct messages
    match /conversations/{conversationId}/messages/{messageId} {
      allow read: if request.auth != null && 
        request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants;
      
      allow create: if request.auth != null && 
        request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants &&
        !isBlockedInDirectMessage(conversationId);
      
      allow update, delete: if request.auth != null && 
        request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants;
    }
    
    // Helper function to check if sender is blocked by recipient (direct messages only)
    function isBlockedInDirectMessage(conversationId) {
      let conversation = get(/databases/$(database)/documents/conversations/$(conversationId)).data;
      
      // If not a direct message, blocking doesn't apply
      if (conversation.type != 'direct') {
        return false;
      }
      
      // Get the other participant (recipient)
      let otherParticipant = conversation.participants[0] == request.auth.uid 
        ? conversation.participants[1] 
        : conversation.participants[0];
      
      // Check if recipient has blocked sender
      let recipientDoc = get(/databases/$(database)/documents/users/$(otherParticipant)).data;
      let blockedUsers = recipientDoc.blockedUsers;
      
      return blockedUsers != null && request.auth.uid in blockedUsers;
    }
    
    // Typing indicators - only conversation participants (Phase 5)
    match /conversations/{conversationId}/typingUsers/{userId} {
      allow read, write: if request.auth != null && 
        request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants;
    }
    
    // ===== AI FEATURES (Phase 3/4) =====
    
    // AI Summaries - only conversation participants can read
    match /conversations/{conversationId}/ai_summaries/{summaryId} {
      allow read: if request.auth != null && 
        request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants;
      // Only Cloud Functions can write
      allow write: if false;
    }
    
    // AI Action Items - participants can read, only Cloud Functions can write
    match /conversations/{conversationId}/ai_action_items/{itemId} {
      allow read: if request.auth != null && 
        request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants;
      
      // Phase 4: Cloud Functions handle all writes (including admin assignments)
      allow write: if false;
    }
    
    // AI Decisions - only conversation participants can read
    match /conversations/{conversationId}/ai_decisions/{decisionId} {
      allow read: if request.auth != null && 
        request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants;
      // Only Cloud Functions can write
      allow write: if false;
    }
    
    // AI Cache Documents
    match /conversations/{conversationId}/ai_cache/{cacheDocId} {
      allow read: if request.auth != null && 
        request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants;
      
      // Only Cloud Functions can write
      allow write: if false;
    }
  }
}